<template>
<!-- Right panel with reveal effect-->
<div class="panel panel-right panel-reveal ${theme == 'theme-dark' && $h`theme-dark`}" @panel:open=${onPanelOpen}>
  <div class="view">
    <div class="page">
      <div class="navbar">
        <div class="navbar-inner">
          <div class="title">Menú</div>
        </div>
      </div>
      <div class="page-content">
        <div class="list">
          <ul>
            <li>
              <div class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">Usuario</div>
                  <div class="item-input-wrap">
                    <i class="icon f7-icons color-blue">person</i>
                    <span id="menu-username">${displayName}</span>
                  </div>
                </div>
              </div>
            </li>
            <li>
              <div class="item-content">
                <div class="item-inner">
                  <div class="item-title">Tema claro</div>
                  <div class="item-after">
                    <label class="toggle toggle-init">
                      <input type="checkbox" id="light-theme" @click=${setTheme} /><i class="toggle-icon"></i>
                    </label>
                  </div>
                </div>
              </div>
            </li>
            <li>
              <div class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">Sesión</div>
                  <div class="item-input-wrap">
                    ${isLogged && $h`
                    <a class="link panel-close color-yellow" href="#" @click=${logout}>
                      Salir <span class="material-icons">logout</span>
                    </a>
                    `}
                    ${!isLogged && $h`
                    <a class="link panel-close color-green" href="/login/">
                      <span class="material-icons">login</span> Ingresar
                    </a>
                    `}
                  </div>
                </div>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
</template>
<script>
import * as localForage from "localforage";
import themes from '../../js/stores/theme.js';
import user from '../../js/stores/user.js';

export default (props, { $f7, $, $on, $onMounted, $update, $f7router }) => {
  let theme = themes.getters.Name.value;
  let isLogged = user.getters.isLogged.value;
  let displayName = user.getters.displayName.value['contactName'] || '';

  const onPanelOpen = () => {
  };

  $onMounted(() => {
    $('#light-theme').prop('checked', (theme != 'theme-dark') ? true : false );
    localForage.getItem('theme').then( (value) => {
      if (value != 'theme-dark'){ $(".panel-right").removeClass("theme-dark"); }
    });
  });

  const logout = () => {
    user.dispatch('logOut').then( () => {
      $f7router.navigate('/');
      $f7.toast.show( { text: "Ha cerrado sesión." });
    });
  };

  const setTheme = () => {
    if ($("#light-theme").prop('checked')){
      $("#app, .panel-right").removeClass("theme-dark");
    }
    else{
      $("#app, .panel-right").addClass("theme-dark");
    }
    theme = !$("#light-theme").prop('checked') ? 'theme-dark' : '';
    localForage.setItem('theme', theme).then( (val) => {
      themes.dispatch('changeTheme', theme);
    });
  };

  return $render;
}
</script>
